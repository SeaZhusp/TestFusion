# 服务端开发规范

## 1. 项目结构

```
backend/
├── app/
│   ├── api/           # API路由层
│   ├── core/          # 核心配置
│   │   ├── dependencies/  # 依赖注入
│   │   ├── enums.py       # 枚举定义
│   │   ├── global_exc.py  # 全局异常处理
│   │   ├── response.py    # 响应格式
│   │   └── middlewares.py # 中间件
│   ├── crud/          # 数据访问层
│   ├── models/        # 数据模型
│   ├── schemas/       # 数据验证
│   ├── services/      # 业务逻辑层
│   ├── params/        # 查询参数
│   ├── utils/         # 工具函数
│   ├── config.py      # 配置文件
│   └── app.py         # 应用入口
├── main.py            # 启动文件
└── requirements.txt   # 依赖管理
```

## 2. 开发规范

### 2.1 命名规范

- **文件名**: 使用小写字母和下划线，如 `user_service.py`
- **类名**: 使用大驼峰命名法，如 `UserService`
- **函数名**: 使用小写字母和下划线，如 `get_user_list`
- **变量名**: 使用小写字母和下划线，如 `user_data`
- **常量**: 使用大写字母和下划线，如 `MAX_RETRY_COUNT`

### 2.2 代码分层

#### API层 (`app/api/`)
- 负责路由定义和请求处理
- 只做参数验证和响应格式化
- 调用Service层处理业务逻辑

```python
@router.post("/login", summary="用户登录")
async def login(data: LoginIn, auth: Auth = Depends(OpenAuth())):
    result = await UserService.login(auth, data)
    return SuccessResponse(data=result, msg="登录成功")
```

### 2.3 RESTful API设计规范

#### 2.3.1 URL设计原则

- **使用名词而非动词**: 使用资源名称，如 `/users` 而不是 `/getUsers`
- **使用复数形式**: 资源集合使用复数，如 `/users`、`/articles`
- **使用层级结构**: 表示资源关系，如 `/users/{id}/orders`
- **使用连字符分隔**: 多词资源使用连字符，如 `/user-profiles`

#### 2.3.2 HTTP方法使用

| 方法 | 用途 | 示例 |
|------|------|------|
| GET | 获取资源 | `GET /users` - 获取用户列表<br>`GET /users/{id}` - 获取单个用户 |
| POST | 创建资源 | `POST /users` - 创建新用户 |
| PUT | 完整更新资源 | `PUT /users/{id}` - 完整更新用户信息 |
| PATCH | 部分更新资源 | `PATCH /users/{id}` - 部分更新用户信息 |
| DELETE | 删除资源 | `DELETE /users/{id}` - 删除用户 |

#### 2.3.3 状态码使用

| 状态码 | 含义 | 使用场景 |
|--------|------|----------|
| 200 | OK | 请求成功 |
| 201 | Created | 资源创建成功 |
| 204 | No Content | 删除成功，无返回内容 |
| 400 | Bad Request | 请求参数错误 |
| 401 | Unauthorized | 未认证 |
| 403 | Forbidden | 无权限 |
| 404 | Not Found | 资源不存在 |
| 422 | Unprocessable Entity | 请求格式正确但语义错误 |
| 500 | Internal Server Error | 服务器内部错误 |

#### 2.3.4 查询参数规范

- **分页**: `?page=1&limit=10`
- **排序**: `?sort=created_at&order=desc`
- **过滤**: `?status=active&role=admin`
- **搜索**: `?search=keyword`
- **字段选择**: `?fields=id,name,email`

#### 2.3.5 响应格式规范

```json
{
    "code": 200,
    "message": "success",
    "data": {
        "id": 1,
        "name": "张三",
        "email": "zhangsan@example.com"
    },
    "meta": {
        "page": 1,
        "limit": 10,
        "total": 100
    }
}
```

#### 2.3.6 错误响应格式

```json
{
    "code": 400,
    "message": "请求参数错误",
    "errors": [
        {
            "field": "email",
            "message": "邮箱格式不正确"
        }
    ]
}
```

#### 2.3.7 API版本控制

- **URL版本**: `/api/v1/users`
- **Header版本**: `Accept: application/vnd.api+json;version=1`
- **推荐使用URL版本控制**

#### 2.3.8 接口命名示例

```python
# 用户管理接口
@router.get("/users", summary="获取用户列表")
@router.post("/users", summary="创建用户")
@router.get("/users/{user_id}", summary="获取用户详情")
@router.put("/users/{user_id}", summary="更新用户信息")
@router.patch("/users/{user_id}", summary="部分更新用户")
@router.delete("/users/{user_id}", summary="删除用户")

# 用户订单接口
@router.get("/users/{user_id}/orders", summary="获取用户订单列表")
@router.post("/users/{user_id}/orders", summary="创建用户订单")
@router.get("/users/{user_id}/orders/{order_id}", summary="获取订单详情")
```

#### Service层 (`app/services/`)
- 处理业务逻辑
- 调用CRUD层进行数据操作
- 处理异常和权限验证

#### CRUD层 (`app/crud/`)
- 继承BaseDal类
- 实现具体的数据访问操作
- 不包含业务逻辑

#### Model层 (`app/models/`)
- 定义数据库模型
- 继承BaseModel基类
- 包含字段定义和验证

#### Schema层 (`app/schemas/`)
- 定义请求和响应数据结构
- 使用Pydantic进行数据验证
- 区分输入和输出Schema

### 2.4 数据库规范

#### 模型定义
- 所有模型继承BaseModel
- 包含标准字段：id, created_at, updated_at
- 使用软删除：is_delete字段

#### 查询规范
- 使用异步SQLAlchemy
- 支持分页、排序、过滤
- 统一使用BaseDal提供的方法

### 2.5 认证授权

#### 认证类型
- `OpenAuth`: 开放接口，无需认证
- `UserAuth`: 需要用户认证
- 支持权限验证和角色控制

#### JWT Token
- 使用JWT进行身份验证
- Token包含用户ID和用户名
- 支持Token过期时间配置

### 2.6 异常处理

#### 自定义异常
```python
class CustomException(Exception):
    def __init__(self, msg: str, code: int = 400, status_code: int = 400):
        self.msg = msg
        self.code = code
        self.status_code = status_code
```

#### 全局异常处理
- 统一异常响应格式
- 区分开发和生产环境
- 记录详细错误日志

### 2.7 响应格式

#### 成功响应
```json
{
    "code": 200,
    "message": "success",
    "data": {}
}
```

#### 错误响应
```json
{
    "code": 400,
    "message": "错误信息",
    "data": []
}
```

### 2.8 配置管理

#### 环境变量
- 使用pydantic-settings管理配置
- 支持.env文件配置
- 区分开发和生产环境

#### 数据库配置
- 使用异步数据库连接
- 配置连接池参数
- 支持数据库迁移

### 2.9 代码质量

#### 类型注解
- 所有函数参数和返回值都要有类型注解
- 使用Union、Optional等类型提示

#### 文档规范
- API接口添加summary和description
- 类和函数添加docstring
- 使用中文注释

#### 测试规范
- 编写单元测试
- 测试覆盖率不低于80%
- 使用pytest进行测试

### 2.10 安全规范

#### 密码处理
- 使用bcrypt加密密码
- 不存储明文密码
- 密码强度验证

#### 输入验证
- 使用Pydantic进行数据验证
- 防止SQL注入
- 限制请求大小

#### 权限控制
- 基于角色的访问控制
- 数据权限控制
- API权限验证

### 2.11 性能优化

#### 数据库优化
- 使用索引优化查询
- 避免N+1查询问题
- 合理使用连接池

#### 缓存策略
- 使用Redis缓存热点数据
- 设置合理的缓存过期时间
- 缓存更新策略

## 3. 开发流程

1. **需求分析**: 明确功能需求和接口设计
2. **数据库设计**: 设计数据模型和表结构
3. **代码实现**: 按照分层架构实现功能
4. **测试验证**: 编写测试用例并验证
5. **代码审查**: 进行代码审查和优化
6. **部署上线**: 部署到生产环境

## 4. 工具和依赖

### 核心依赖
- FastAPI: Web框架
- SQLAlchemy: ORM框架
- Pydantic: 数据验证
- JWT: 身份认证
- Alembic: 数据库迁移

### 开发工具
- uvicorn: ASGI服务器
- pytest: 测试框架
- black: 代码格式化
- flake8: 代码检查

## 5. 部署规范

### 环境配置
- 使用Docker容器化部署
- 配置环境变量
- 设置日志级别

### 监控告警
- 接口响应时间监控
- 错误率监控
- 系统资源监控

---

*本文档基于FastAPI框架制定，适用于TestFusion项目的服务端开发。* 